<div class="container-fluid mt-3">

  <div class="page-header">
    <div class="row align-items-center">
      <div class="col">
        <ul class="breadcrumb">
          <li class="breadcrumb-item">Purchase</li>
          <li class="breadcrumb-item active">Product</li>
          <li class="breadcrumb-item active">{{pageTitle}}</li>
          <li *ngIf="pageTitle==='Edit'" class="breadcrumb-item active">
            <span routerLink="/common/product/create" style="color:blue;">
              <i class="fas fa-plus-circle"></i>(Create)</span> <br />
          </li>
          <li *ngIf="pageTitle==='View'" class="breadcrumb-item active">
            <span routerLink="/common/product/edit/{{id}}" style="color:blue;">
              <i class="fas fa-plus-circle"></i>(Edit)</span> <br />
          </li>
        </ul>
      </div>
      <div class="col-auto float-right ml-auto">
        <a id="backBtn" [routerLink]="['/common/product/list']" class="btn btn-sm btn-outline-secondary">
          <i class="fas fa-times me-1"></i> Back
        </a>
      </div>
    </div>
  </div>

  <span style="text-align:left;">
    <h3 class="card-title">Purchase {{pageTitle}}</h3>
  </span>
  <br />


  <div class="row">
    <div class="col-lg-12">
      <div class="card customCard">
        <div class="card-body">
          <form [formGroup]="createForm">
            <div class="row">

              <div class="col-md-3 form-group">
                <label for="name-f">Organization *</label>
                <ng-select (change)="loadAllBranch()" (keyup)="setSearch($event.target)"
                (click)="setSearch($event.target)"
                 [items]="menuOptions"
                  bindLabel="orgName" bindValue="id" formControlName="orgId" (search)="onSearch('Organization')"
                  (scrollToEnd)="loadMore('Organization')" [loading]="loadDropOrg" [clearable]="true"
                  [closeOnSelect]="true" [editableSearchTerm]="false" [addTag]="false" class="form-control-patch">
                </ng-select>

              </div>

              <div class="col-md-3 form-group">
                <label for="name-f">Branch*</label>
                <ng-select (change)="loadInventory()" [items]="branchList" bindLabel="name" bindValue="id"
                  formControlName="branchId" [clearable]="true" [closeOnSelect]="true" [editableSearchTerm]="false"
                  [addTag]="false" class="form-control-patch">
                </ng-select>
              </div>

              <div class="col-md-3 form-group">
                <label for="name-f">Receiving Inventory*</label>
                <ng-select [items]="invList" bindLabel="name" bindValue="id" formControlName="inventoryId"
                  [clearable]="true" [closeOnSelect]="true" [editableSearchTerm]="false" [addTag]="false"
                  class="form-control-patch">
                </ng-select>
              </div>

              <div class="col-md-3 form-group">
                <label for="name-f">Supplier*</label>
                <ng-select (keyup)="setSearch($event.target)" [items]="suppList" 
                  bindLabel="name" bindValue="id"
                  formControlName="supplierId" (keyup)="onSearch('Supplier')" 
                  (click)="onSearch('Supplier')" 
                  (scrollToEnd)="loadMore('Supplier')"
                  [loading]="loadDropSupp" [clearable]="true" [closeOnSelect]="true" 
                  [editableSearchTerm]="false"
                  [addTag]="false" class="form-control-patch">
                </ng-select>
              </div>
            </div>
          </form>
        </div>
      </div>
      &nbsp;&nbsp;

      <!------------select product -------------------------------------------------------------->
          <form [formGroup]="selectForm">
            <div class="row">
             <div class="col-md-3 form-group">
                <label for="name-f">Search Product </label>
                <ng-select style="width: 500px;" (keyup)="setSearch($event.target)" [items]="products"
                (click)="onSearch('Product')"
                (change)="setProductDetails($event)"
                  bindLabel="productName" bindValue="id" formControlName="product" (search)="onSearch('Product')"
                  (scrollToEnd)="loadMore('Product')" [loading]="loadDropPro" [clearable]="true"
                  [closeOnSelect]="true" [editableSearchTerm]="false" [addTag]="false" class="form-control-patch">
                </ng-select>
              </div>
            </div>
          </form>
      &nbsp;&nbsp;
      <!-----------------------------------Selling price settings---------------------------------->
        <div class="card customCard">
          <div class="border rounded p-1 position-relative">
            <span class="position-absolute top-0 start-50 translate-middle bg-white px-2 small">
              Product List
            </span>
      
            <form [formGroup]="purchaseForm">
              <div class="table-responsive mt-0">
                  <table class="table table-striped custom-table">
                    <thead>
                      <th>SL</th>
                      <th>Product</th>
                      <th style="width:9%;">Unit Price</th>
                      <th style="width:8%;">Quantity</th>
                      <th style="width:13%;">Discount</th>
                      <th style="width:180px;">Vat</th>
                      <th style="width:15%;">Net Price<br/>
                      <span style="font-size:0.6em;">(Unit Price*Quantity - discount)</span></th>
                      <th style="width:15%;">Total Price<br/>
                        <span style="font-size:0.6em;">(Net Price + vat)</span></th>
                                          
                    </thead>
                    <tbody formArrayName="purchPrices">
                      <tr *ngFor="let itemrow of allPurchs.controls; let i=index;let l=last" [formGroupName]="i">
                        <td>{{i+1}}</td>
                        <td>
                          <input  readonly style="font-size:0.89em;" formControlName="productName" class="form-control"  type="text">
                        </td>
                        <td>
                          <input formControlName="unitPrice" (keyup)="calculateData(i)" class="form-control"  type="text">
                        </td>
                        <td>
                          <div class="row g-0">
                            <span class="d-inline-flex align-items-center" style="color:green;">
                              [{{stocks[i]}}] 
                              <input formControlName="quantity" (keyup)="calculateData(i)" class="form-control ms-2" type="text" style="width:120px;">
                            </span>
                          </div>

                        </td>
                        <td>
                          <div class="row g-0">
                            <div class="col-7">
                              <input formControlName="disAmount" (keyup)="setDiscount('amount',i)"    class="form-control" type="text" placeholder="Amount">
                            </div>
                            <div class="col-5">
                              <input formControlName="disPct"   (keyup)="setDiscount('percentage',i)" class="form-control" type="text" placeholder="%">
                            </div>
                          </div>
                        </td>
                        
                        <td>
                          <div class="row g-0">
                            <div class="col-7">
                              <input formControlName="vatAmount" (keyup)="setVat('amount',i)"  class="form-control" type="text" placeholder="Amount">
                            </div>
                            <div class="col-5">
                              <input formControlName="vatPct" (keyup)="setVat('percentage',i)"  class="form-control" type="text" placeholder="%">
                            </div>
                          </div>
                        </td>

                        <td>
                          <input readonly formControlName="netAmount" class="form-control"  type="number">
                        </td>

                        <td>
                          <input readonly   formControlName="totalAmount" class="form-control"  type="number">
                        </td>

                        <td>
                          <button *ngIf="opMode!=='view'" (click)="removeSell(i)"
                            class="btn btn-danger btn-sm">
                            <i class="fa fa-minus"></i></button>
                          &nbsp;
                          <button *ngIf="opMode!=='view'" (click)="addSell(i)" class="btn btn-danger btn-sm">
                            <i class="fa fa-plus"></i>
                          </button>
                        </td>

                      </tr>
                    </tbody>
                  </table>
              </div>
            </form>
          </div>
        </div>
      
      &nbsp;&nbsp;
      <div class="card customCard">
        <div class="card-body p-2 position-relative">
          <span class="position-absolute top-0 start-50 translate-middle bg-white px-2 small">
            Purchase Summary
          </span>
            <div class="table-responsive mt-3">
              <table class="table table-striped custom-table">
               <tr>
                <td>Total</td>
                <td>{{priceSum}}</td>
                <td>Total Discount</td>
                <td>{{totalDiscount}}</td>
               </tr>
               <tr>
                <td>Total Vat</td>
                <td>{{totalVat}}</td>
                <td>Total Net</td>
                <td>{{totalNetPrice}}</td>
                <td>Grand Total</td>
                <td>{{pricePayable}}</td>
               </tr>
              </table>
            </div>
  
        </div>
      </div>

      
      <div class="d-flex gap-2 mt-2" *ngIf="opMode==='edit' || opMode==='create'">
        <button type="submit" class="btn btn-sm btn-primary" (click)="onSubmit()">
          <i class="fas fa-save me-1"></i> Save
        </button>
      </div>


    </div>
  </div>



  <div *ngIf="loading" class="loader-overlay">
    <div class="spinner"></div>
    <span>Saving user...</span>
  </div>

  <!---- child menu details -->

  <!-- /Delete Modal -->
  <br />

  <!-- simple-modal.component.html -->

  <!-- Button to trigger modal -->
  <button #myButton type="button" style="display:none;" class="btn btn-primary" data-bs-toggle="modal"
    data-bs-target="#exampleModal">
    Open Modal
  </button>
  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Simple Modal</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Similar product you may be creating which is already exist </p>
          <p>Please recheck or be confirm before create</p>
          <table class="data-table" style="font-size: smaller;">
            <thead>
              <tr>
                <th>SL</th>
                <th>Name</th>
                <th>Full Name</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let x of similarProduct; index as i">
                <td>{{ i + 1 }}</td>
                <td>{{ x.name}}</td>
                <td>{{ x.fullName}}</td>
                <td>{{ x.description}}</td>
              </tr>
            </tbody>

          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="confirmSimilarity()">I Confirm</button>
        </div>
      </div>
    </div>
  </div>


</div>


<!-- Delete Modal -->